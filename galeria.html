<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Galería de fotos — Adriana & Santiago</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<link href="styles.css" rel="stylesheet" />
<style>
body { font-family:'Inter', sans-serif; margin:0; padding:0; background:#fff;}
h1 { text-align:center; font-family:'Playfair Display', serif; font-size:2.5rem; margin:2rem 0; }

#gallery {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  max-width:1200px;
  margin:2rem auto;
}

.gallery-item {
  border-radius:16px;
  overflow:hidden;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
}

.gallery-item img {
  width:100%;
  display:block;
  border-radius:16px;
  object-fit:cover;
  height:250px;
  transition: transform 0.3s ease;
}

.gallery-item img:hover { transform: scale(1.05); }

.btn-container { text-align:center; margin:2rem 0; }

#upload-form { text-align:center; margin:2rem auto; }
#upload-form input[type="file"] { display:none; }

.custom-file-upload {
  display: inline-block;
  padding: 0.6rem 1.2rem;
  cursor: pointer;
  border-radius: 12px;
  background: linear-gradient(135deg, #f9f5f0, #fff3e6);
  border: 2px solid #d4af37;
  color: #333;
  font-weight: 600;
  transition: all 0.3s ease;
  margin-right: 1rem;
}
.custom-file-upload:hover {
  background: linear-gradient(135deg, #fff3e6, #f9f5f0);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
#upload-form button { margin-top: 0.5rem; }

#preview-container img {
  width: 100px; height:100px; object-fit:cover;
  margin:0.25rem; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.2);
}
body { padding-top: 100px; } /* espacio para navbar fijo */

.btn-container.btn-right {
  text-align: right;
  margin: 1.5rem 0;
}

main.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

</style>
</head>
<body>
<header class="nav">
  <a href="/index.html" class="brand">A ❤ S</a>
  <nav>
    <a href="/index.html#inicio" class="btn btn-gold btn-lg">Inicio</a>
    <a href="/index.html#detalle" class="btn btn-gold btn-lg">Detalles</a>
    <a href="/index.html#rsvp" class="btn btn-gold btn-lg">RSVP</a>
  </nav>
  <button class="hamburger" aria-label="Abrir menú" aria-expanded="false">☰</button>
</header>

<main class="container">
  <h1>Galería de fotos de nuestra boda</h1>

  <div class="btn-container btn-right">
    <a href="/index.html" class="btn btn-gold btn-lg">Volver al inicio</a>
  </div>

  <form id="upload-form">
  <label class="custom-file-upload">
    <input type="file" id="photo-input" accept="image/*" multiple required />
    Seleccionar fotos
  </label>
  <button type="submit" class="btn btn-gold btn-lg">Subir fotos</button>
  <div id="upload-status"></div>
  <div id="preview-container"></div>
</form>

  <div id="gallery" aria-live="polite">Cargando fotos…</div>
</main>

<footer class="footer" style="text-align:center;margin:2rem 0;">
  Con ❤️ por Adriana & Santiago — Nos vemos el 21/03/2026
</footer>

<script>
const gallery = document.getElementById('gallery');
const uploadForm = document.getElementById('upload-form');
const photoInput = document.getElementById('photo-input');
const uploadStatus = document.getElementById('upload-status');
const previewContainer = document.getElementById('preview-container');

// Menú móvil
document.querySelector('.hamburger')?.addEventListener('click', (e)=>{
  const nav = document.querySelector('.nav nav');
  const btn = e.currentTarget;
  const isOpen = nav.style.display === 'flex';
  nav.style.display = isOpen ? 'none' : 'flex';
  btn.setAttribute('aria-expanded', String(!isOpen));
});

// Renderizar galería
function renderGallery(photos) {
  gallery.innerHTML = '';
  photos.forEach(photo => {
    const div = document.createElement('div');
    div.className = 'gallery-item';
    const img = document.createElement('img');
    img.src = photo.url;
    img.alt = photo.filename || 'Foto de la boda';
    div.appendChild(img);
    gallery.appendChild(div);
  });
}

// Cargar fotos desde JSON y localStorage
async function loadGallery() {
  gallery.innerHTML = 'Cargando fotos…';
  try {
    const res = await fetch('/photos.json');
    const data = res.ok ? await res.json() : [];
    let stored = JSON.parse(localStorage.getItem('localPhotos') || '[]');
    if (data.length) {
      const githubUrls = data.map(p => p.url);
      stored = stored.filter(p => !githubUrls.includes(p.url));
      localStorage.setItem('localPhotos', JSON.stringify(stored));
    }
    const combined = [...data, ...stored];
    if (!combined.length) {
      gallery.innerHTML = '<p>No hay fotos aún.</p>';
      return;
    }
    renderGallery(combined.reverse());
  } catch(err){
    console.error(err);
    gallery.innerHTML = '<p>Error cargando fotos.</p>';
  }
}

loadGallery();

// Vista previa de fotos seleccionadas
photoInput.addEventListener('change', () => {
  previewContainer.innerHTML = '';
  const files = Array.from(photoInput.files);
  if (!files.length) return;
  uploadStatus.textContent = `${files.length} foto(s) seleccionada(s)`;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.alt = file.name;
      previewContainer.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});

// Subida de fotos y almacenamiento local
uploadForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!photoInput.files.length) return;
  const files = Array.from(photoInput.files);
  uploadStatus.textContent = `Subiendo ${files.length} archivo(s)…`;
  let successCount = 0;
  let localPhotos = JSON.parse(localStorage.getItem('localPhotos') || '[]');

  for (const file of files) {
    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset','netlify_upload');
      const cloudRes = await fetch('https://api.cloudinary.com/v1_1/drssjjayn/image/upload',{ method:'POST', body:formData });
      const cloudData = await cloudRes.json();
      if(!cloudData.secure_url) throw new Error('Error subiendo imagen a Cloudinary');

      // Guardar localmente inmediatamente
      localPhotos.push({ filename:file.name, url:cloudData.secure_url, uploaded_at:new Date().toISOString() });
      localStorage.setItem('localPhotos', JSON.stringify(localPhotos));

      // Llamar Netlify
      await fetch('/.netlify/functions/upload-photo', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ filename:file.name, cloudinaryUrl:cloudData.secure_url })
      });

      successCount++;
    } catch(err){
      console.error(err);
      uploadStatus.textContent = `Error subiendo ${file.name}`;
    }
  }

  uploadStatus.textContent = `${successCount} de ${files.length} fotos subidas correctamente!`;
  photoInput.value='';
  previewContainer.innerHTML='';
  loadGallery();
});
</script>
</body>
</html>
