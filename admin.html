<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin RSVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: system-ui, sans-serif; }

    .admin-wrapper{
      max-width:1100px;
      margin:40px auto;
      padding:16px;
    }

    h1 { margin-bottom: 8px; }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:12px 0;
    }

    .controls input{
      flex:1;
      padding:10px;
      font-size:15px;
    }

    .controls button{
      padding:10px 14px;
      cursor:pointer;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:16px;
    }

    th,td{
      padding:12px 10px;
      border-bottom:1px solid #eee;
      vertical-align:top;
    }

    th{
      text-align:left;
      font-weight:600;
    }

    .badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:20px;
      font-size:.85rem;
      border:1px solid #ddd;
    }

    .badge.ok{ background:#e9f8ef; }
    .badge.no{ background:#fdeaea; }

    .summary{
      margin-top:12px;
      font-size:14px;
    }

    /* ===== MOBILE / CARDS ===== */
    body.cards-only thead { display:none; }

    @media (max-width:768px), body.cards-only {

      .admin-wrapper{
        margin:0;
        padding:12px;
      }

      table, thead, tbody, th, tr{
        display:block;
      }

      tr{
        background:#fff;
        margin-bottom:16px;
        border-radius:12px;
        padding:12px;
        box-shadow:0 4px 10px rgba(0,0,0,.05);
      }

      td{
        display:flex;
        justify-content:space-between;
        gap:12px;
        padding:6px 0;
        border:none;
        font-size:15px;
      }

      td::before{
        content:attr(data-label);
        font-weight:600;
        color:#777;
        font-size:13px;
      }

      td[data-label="Mensaje"]{
        flex-direction:column;
      }
    }
  </style>
</head>
<body>

<div class="admin-wrapper">
  <h1>Panel de Confirmaciones</h1>

  <p>
    Total registros: <span id="total-registros"></span><br>
    Total invitados: <strong><span id="total-invitados"></span></strong>
  </p>

  <div class="controls">
    <input id="buscador" placeholder="Buscar por nombre o telÃ©fono">
    <button onclick="exportarExcel()">ðŸ“¤ Exportar Excel</button>
    <button onclick="toggleCards()">ðŸ“± Modo cards</button>
  </div>

  <div class="summary" id="resumen"></div>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>TelÃ©fono</th>
        <th>Asistencia</th>
        <th>AcompaÃ±antes</th>
        <th>RestricciÃ³n</th>
        <th>Mensaje</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
let datos = [];
let filtrados = [];

async function init() {
  const clave = await new Promise(resolve => {
    const o=document.createElement("div");
    o.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:9999";
    const c=document.createElement("div");
    const i=document.createElement("input");
    i.type="password"; i.placeholder="Clave"; i.style.padding="12px";
    const b=document.createElement("button");
    b.textContent="Acceder"; b.onclick=()=>{document.body.removeChild(o);resolve(i.value);}
    c.append(i,b); o.appendChild(c); document.body.appendChild(o);
  });

  const res = await fetch('/.netlify/functions/validarClave',{
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({clave})
  });
  const {autorizado}=await res.json();
  if(!autorizado){ document.body.innerHTML="Acceso denegado"; return; }

  const r2=await fetch('/.netlify/functions/obtenerInvitados');
  const j=await r2.json();
  datos=Array.isArray(j)?j:(j.rsvps||[]);
  filtrados=[...datos];

  pintar();
}

document.getElementById("buscador").addEventListener("input",e=>{
  const q=e.target.value.toLowerCase();
  filtrados=datos.filter(r=>
    (r.name||"").toLowerCase().includes(q) ||
    (r.phone||"").toLowerCase().includes(q)
  );
  pintar();
});

function pintar(){
  const tbody=document.getElementById("tbody");
  const tr=document.getElementById("total-registros");
  const ti=document.getElementById("total-invitados");
  const resumen=document.getElementById("resumen");

  tbody.innerHTML="";
  tr.textContent=filtrados.length;

  let invitados=0;
  let dietas={};

  filtrados.forEach(r=>{
    if(r.attendance==="SÃ­"){
      invitados+=1+(r.guests||[]).length;
      if(r.dietary==="SÃ­"){
        const key=(r.dietaryDetails||"Sin detalle").trim();
        dietas[key]=(dietas[key]||0)+1;
      }
    }

    const asis=r.attendance==="SÃ­"
      ? `<span class="badge ok">Asiste</span>`
      : `<span class="badge no">No</span>`;

    const row=document.createElement("tr");
    row.innerHTML=`
      <td data-label="Nombre">${r.name||"â€”"}</td>
      <td data-label="TelÃ©fono">${r.phone||"â€”"}</td>
      <td data-label="Asistencia">${asis}</td>
      <td data-label="AcompaÃ±antes">${(r.guests||[]).join("<br>")||"â€”"}</td>
      <td data-label="RestricciÃ³n">${r.dietary==="SÃ­"?(r.dietaryDetails||"â€”"):"â€”"}</td>
      <td data-label="Mensaje">${r.message||"â€”"}</td>
      <td data-label="Fecha">${r.created_at?new Date(r.created_at).toLocaleString():"â€”"}</td>
    `;
    tbody.appendChild(row);
  });

  ti.textContent=invitados;

  resumen.innerHTML = "ðŸ¥— Restricciones: " +
    (Object.keys(dietas).length
      ? Object.entries(dietas).map(([k,v])=>`${k}: ${v}`).join(" Â· ")
      : "Ninguna");
}

function exportarExcel(){
  let csv="Nombre,Telefono,Asistencia,Acompanantes,Restriccion,Mensaje,Fecha\n";
  filtrados.forEach(r=>{
    csv+=`"${r.name||""}","${r.phone||""}","${r.attendance||""}","${(r.guests||[]).join(" / ")}","${r.dietaryDetails||""}","${(r.message||"").replace(/"/g,'""')}","${r.created_at||""}"\n`;
  });
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="rsvp.xlsx"; // Excel lo abre sin problema
  a.click();
}

function toggleCards(){
  document.body.classList.toggle("cards-only");
}

init();
</script>

</body>
</html>
