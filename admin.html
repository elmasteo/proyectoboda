<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin RSVP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: system-ui, sans-serif;
  background:#fafafa;
}

.admin-wrapper{
  max-width:1100px;
  margin:40px auto;
  padding:16px;
}

h1{ margin-bottom:6px; }

.stats{
  margin-bottom:16px;
}

.controls{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:16px;
}

.controls input{
  flex:1;
  min-width:220px;
  padding:10px;
  font-size:15px;
}

.actions{
  display:flex;
  gap:10px;
}

.actions button{
  padding:10px 14px;
  cursor:pointer;
  border-radius:8px;
  border:1px solid #ccc;
  background:#fff;
}

.summary{
  margin-bottom:20px;
  padding:12px;
  background:#fff;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
  font-size:14px;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:12px 10px;
  border-bottom:1px solid #eee;
  vertical-align:top;
}

th{ text-align:left; }

.badge{
  padding:6px 12px;
  border-radius:20px;
  font-size:.85rem;
  border:1px solid #ddd;
}

.badge.ok{ background:#e9f8ef; }
.badge.no{ background:#fdeaea; }

/* ===== CARDS ===== */
body.cards-only thead{ display:none; }

@media (max-width:768px), body.cards-only{

  .admin-wrapper{
    margin:0;
    padding:12px;
  }

  table, thead, tbody, th, tr{
    display:block;
  }

  tr{
    background:#fff;
    margin-bottom:16px;
    border-radius:12px;
    padding:12px;
    box-shadow:0 4px 10px rgba(0,0,0,.05);
  }

  td{
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding:6px 0;
    border:none;
    font-size:15px;
  }

  td::before{
    content:attr(data-label);
    font-weight:600;
    color:#666;
    font-size:13px;
  }

  td[data-label="Mensaje"]{
    flex-direction:column;
  }
}
</style>
</head>

<body>

<div class="admin-wrapper">
  <h1>Panel de Confirmaciones</h1>

  <div class="stats">
    Total registros: <span id="total-registros"></span><br>
    Total invitados: <strong><span id="total-invitados"></span></strong>
  </div>

  <div class="controls">
    <input id="buscador" placeholder="Buscar por nombre o telÃ©fono">
    <div class="actions">
      <button onclick="exportarExcel()">ðŸ“¤ Exportar Excel</button>
      <button onclick="toggleCards()">ðŸ“± Modo cards</button>
    </div>
  </div>

  <div class="summary" id="resumen"></div>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>TelÃ©fono</th>
        <th>Asistencia</th>
        <th>AcompaÃ±antes</th>
        <th>RestricciÃ³n</th>
        <th>Mensaje</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
let datos=[], filtrados=[];

async function init(){
  const clave = await mostrarLogin();

  const res = await fetch('/.netlify/functions/validarClave',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({clave})
  });
  const {autorizado}=await res.json();
  if(!autorizado){ document.body.innerHTML="Acceso denegado"; return; }

  const r2=await fetch('/.netlify/functions/obtenerInvitados');
  const j=await r2.json();
  datos=Array.isArray(j)?j:(j.rsvps||[]);
  filtrados=[...datos];
  pintar();
}

function mostrarLogin(){
  return new Promise(resolve=>{
    const o=document.createElement("div");
    o.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:9999";

    const c=document.createElement("div");
    c.style.cssText="background:#fff;padding:24px;border-radius:12px;width:280px;text-align:center";

    const i=document.createElement("input");
    i.type="password";
    i.placeholder="Clave de acceso";
    i.style.cssText="width:100%;padding:10px;margin-bottom:12px";

    const b=document.createElement("button");
    b.textContent="Acceder";
    b.style.cssText="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;background:#f5f5f5";
    b.onclick=()=>{ document.body.removeChild(o); resolve(i.value); };

    c.append(i,b); o.appendChild(c); document.body.appendChild(o);
  });
}

document.getElementById("buscador").addEventListener("input",e=>{
  const q=e.target.value.toLowerCase();
  filtrados=datos.filter(r=>
    (r.name||"").toLowerCase().includes(q) ||
    (r.phone||"").toLowerCase().includes(q)
  );
  pintar();
});

function pintar(){
  const tbody=document.getElementById("tbody");
  const tr=document.getElementById("total-registros");
  const ti=document.getElementById("total-invitados");
  const resumen=document.getElementById("resumen");

  tbody.innerHTML="";
  tr.textContent=filtrados.length;

  let invitados=0, dietas={};

  filtrados.forEach(r=>{
    if(r.attendance==="SÃ­"){
      invitados+=1+(r.guests||[]).length;
      if(r.dietary==="SÃ­"){
        const k=(r.dietaryDetails||"Sin detalle");
        dietas[k]=(dietas[k]||0)+1;
      }
    }

    const asis=r.attendance==="SÃ­"
      ? `<span class="badge ok">Asiste</span>`
      : `<span class="badge no">No</span>`;

    const row=document.createElement("tr");
    row.innerHTML=`
      <td data-label="Nombre">${r.name||"â€”"}</td>
      <td data-label="TelÃ©fono">${r.phone||"â€”"}</td>
      <td data-label="Asistencia">${asis}</td>
      <td data-label="AcompaÃ±antes">${(r.guests||[]).join("<br>")||"â€”"}</td>
      <td data-label="RestricciÃ³n">${r.dietary==="SÃ­"?(r.dietaryDetails||"â€”"):"â€”"}</td>
      <td data-label="Mensaje">${r.message||"â€”"}</td>
      <td data-label="Fecha">${r.created_at?new Date(r.created_at).toLocaleString():"â€”"}</td>
    `;
    tbody.appendChild(row);
  });

  ti.textContent=invitados;
  resumen.innerHTML="ðŸ¥— Restricciones: "+
    (Object.keys(dietas).length
      ? Object.entries(dietas).map(([k,v])=>`${k}: ${v}`).join(" Â· ")
      : "Ninguna");
}

function exportarExcel(){
  let html=`<table border="1">
  <tr><th>Nombre</th><th>TelÃ©fono</th><th>Asistencia</th><th>AcompaÃ±antes</th><th>RestricciÃ³n</th><th>Mensaje</th><th>Fecha</th></tr>`;
  filtrados.forEach(r=>{
    html+=`<tr>
      <td>${r.name||""}</td>
      <td>${r.phone||""}</td>
      <td>${r.attendance||""}</td>
      <td>${(r.guests||[]).join(" / ")}</td>
      <td>${r.dietaryDetails||""}</td>
      <td>${r.message||""}</td>
      <td>${r.created_at||""}</td>
    </tr>`;
  });
  html+="</table>";

  const blob=new Blob([html],{type:"application/vnd.ms-excel;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="rsvp.xls";
  a.click();
}

function toggleCards(){
  document.body.classList.toggle("cards-only");
}

init();
</script>

</body>
</html>
